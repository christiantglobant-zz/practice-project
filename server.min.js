var express=require("express"),app=express(),port=process.env.PORT||3e3,users=require("./server/models/users.js"),supports=require("./server/models/supports.js"),client=require("./server/models/client.js"),contact=require("./server/models/contact.js"),Helpers=require("./server/helpers/helpers.js"),Messages=require("./server/lib/messages.js"),http=require("http"),path=require("path"),session=require("express-session"),bodyParser=require("body-parser"),sess={user:{data:void 0}},server=http.createServer(app),io=require("socket.io")(server);app.use(session({secret:"password secret",cookie:{maxAge:432e5}}));var bodyParserJson=bodyParser.json({type:"application/json",limit:"50mb"});app.use(express.static("./"));var onLines=[];io.on("connection",function(e){console.log("El nodo con IP: "+e.handshake.address+" Conectado"),e.on("io-refrehs-onlines",function(e){s(onLines)}),e.on("io-server-login",function(o){e.user=o;var r=!1;onLines.length>=1&&onLines.hasOwnProperty("_id")&&onLines.forEach(function(e,s){"object"==typeof e&&"object"==typeof o&&null!==e&&null!==o&&void 0!==e&&void 0!==o&&e.length>=0&&void 0!=e._id&&""!=e._id&&null!=e._id&&void 0!=o._id&&""!=o._id&&null!=o._id&&e._id===o._id&&(r=!0)}),!1===r&&onLines.push(o),s(onLines)}),e.on("io-server-logout",function(e){onLines.forEach(function(s,o){s._id===e._id&&onLines.splice(o,1)}),s(onLines)}),e.on("io-server-new-ser",function(e,s){io.sockets.emit("io-message-new-user",e,s),io.sockets.emit("io-add-new-user",e)}),e.on("io-server-new-ticket",function(e,s){io.sockets.emit("io-add-new-ticket",e)}),e.on("io-server-new-response",function(e,s,o){io.sockets.emit("io-add-new-response",e,s),io.sockets.emit("io-message-new-response",s)}),e.on("io-server-update-sticker",function(e,s){io.sockets.emit("io-add-update-sticker",e)}),e.on("disconnect",function(){console.log("El nodo con IP: "+e.handshake.address+" Desconectado"),onLines=[],io.sockets.emit("io-advertise-login",onLines)});var s=function(e){io.sockets.emit("io-update-onlines",onLines)}}),app.get("/*",function(e,s){s.sendFile(path.join(__dirname+"/index.html"))}).post("/server/logout",function(e,s){e.session=void 0,sess.user.data=void 0,s.send(!0)}).post("/server/newUser",bodyParserJson,function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.body.name,e.body.lastname,e.body.tel,e.body.email,e.body.password])?users.newUser(e.body,e.session.user.data.user).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/updateUser",bodyParserJson,function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.body.name,e.body.lastname,e.body.tel,e.body._id])?users.update(e.body).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/updateClient",bodyParserJson,function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.body.celular,e.body.digito_verif,e.body.email,e.body.identificacion,e.body.nomb_comercial,e.body.razon_social,e.body._id])?client.update(e.body).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/disableClient",bodyParserJson,function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.body.estado,e.body._id])?client.disableClient(e.body).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/disableContact",bodyParserJson,function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.body.estado,e.body._id])?contact.disableContact(e.body).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/updateContact",bodyParserJson,function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.body.company,e.body.fullname,e.body.phones,e.body.email])?contact.update(e.body).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/updateSupport",bodyParserJson,function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.body.company,e.body.typeSupport,e.body.medium,e.body.category,e.body.responsible,e.body.imputability,e.body.priority,e.body.affair,e.body.description])?supports.updateSupport(e.body).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/changePassword",bodyParserJson,function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.body.password])?users.changePassword(e.body.password,e.session.user.data._id).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/newClient",bodyParserJson,function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.body.nit,e.body.cod,e.body.business_name,e.body.tradename,e.body.mail,e.body.phone])?client.newClient(e.body).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/allClients",function(e,s){e.session&&"object"==typeof e.session.user?client.allClients().then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/getUsers",function(e,s){e.session&&"object"==typeof e.session.user?users.allusers().then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/login",function(e,s){sess=e.session,users.verifyCredentials(e.query.username,e.query.password).then(function(o){e.session.user=o;e.session.cookie.expires=new Date(Date.now()+432e5),e.session.cookie.maxAge=432e5,s.send(o)})}).post("/server/saveSupport",bodyParserJson,function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.body.company,e.body.typeSupport,e.body.medium,e.body.category,e.body.responsible,e.body.imputability,e.body.dateRequest,e.body.priority,e.body.affair,e.body.description])?supports.saveSupport(e.body,e.session.user.data._id).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/newSupportDetalls",bodyParserJson,function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.body.sticker,e.body.response])?(e.body.username=e.session.user.data._id,supports.newSupportDetalls(e.body).then(function(e){s.send(e)})):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/newConct",function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.query.company,e.query.fullname,e.query.phones,e.query.email])?supports.newConct(e.query).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/newConctComp",function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.query.company,e.query.fullname,e.query.phones,e.query.email])?contact.newConct(e.query).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/changeStatusTicket",function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.query.status,e.query.ticket])?"NUEVO"!==e.query.status?supports.changeStatusTicket(e.query,e.session.user.data).then(function(e){s.send(e)}):s.send({data:!1,event:!1,msj:"Error, No se puede cambiar el esta a nuevo!"}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/changeUserTicket",function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.query.ticket,e.query.user,e.query.response])?supports.changeUserTicket(e.query).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/changePriority",function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.query.ticket,e.query.priority,e.query.response])?supports.changePriority(e.query).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/getContactComp",function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.query.id])?supports.getContactComp(e.query).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/allSupport",function(e,s){e.session&&"object"==typeof e.session.user?supports.allSupport().then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/getHistory",function(e,s){e.session&&"object"==typeof e.session.user?supports.getHistory().then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/getTotalSuports",function(e,s){e.session&&"object"==typeof e.session.user?supports.getTotalSuports().then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/getTotalSuportsMeses",function(e,s){e.session&&"object"==typeof e.session.user?supports.getTotalSuportsMeses().then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/getTotalSuportsResult",function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.query.init,e.query.finis])?supports.getTotalSuportsResult(e.query).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/allUsuarios",function(e,s){e.session&&"object"==typeof e.session.user?users.allusers().then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/allClientes",function(e,s){supports.allClientes().then(function(e){s.send(e)})}).post("/server/getAllContact",function(e,s){contact.getAllContact().then(function(e){s.send(e)})}).post("/server/infoTickets",function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.query.sticker])?supports.infoTickets(e.query.sticker).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/infoTicketsEdits",function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.query.idem])?supports.infoTicketsEdits(e.query.idem).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/getInfoClient",function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.query.idem])?client.getInfoClient(e.query.idem).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/getresponse",function(e,s){supports.getresponse(e.query.sticker).then(function(e){s.send(e)})}).post("/server/verifySession",function(e,s){var o=!1;e.session&&"object"==typeof e.session.user&&e.session.user.data.user===e.query.username&&new Date(e.session.user.data.lastlogin)<=e.session.cookie.expires&&(o=!0),s.send(o)}).post("/server/updateShareTicket",bodyParserJson,function(e,s){e.session&&"object"==typeof e.session.user?Helpers.emptyDatas([e.body.number,e.body._id])?supports.updateShareTicket(e.body,e.session.user.data.user).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/loadChangesSupports",function(e,s){e.session&&"object"==typeof e.session.user?supports.loadChanges(e.session.user.data._id).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/markViewed",bodyParserJson,function(e,s){e.session&&"object"==typeof e.session.user?(e.body.inbox=e.body.inbox||[],e.body.inbox="string"==typeof e.body.inbox?[e.body.inbox]:e.body.inbox,Helpers.emptyDatas(e.body.inbox)?supports.markViewed(e.body.inbox,e.session.user.data._id).then(function(e){s.send(e)}):s.send({event:!1,data:"global.error.required",msj:Messages.global.error.required})):s.send({event:!1,data:"global.error.loginRequired",msj:Messages.global.error.loginRequired})}).post("/server/logout",function(e,s){e.session=void 0,s.send(!0)}),server.listen(3e3,function(){var e=server.address();console.log("Soporte server listening at",e.address+":"+e.port)});